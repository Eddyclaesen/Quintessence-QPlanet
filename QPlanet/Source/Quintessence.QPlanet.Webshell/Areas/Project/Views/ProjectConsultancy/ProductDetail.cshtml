@using Quintessence.QService.QueryModel.Prm
@model Quintessence.QPlanet.Webshell.Areas.Project.Models.ProjectConsultancy.ProductDetailActionModel
@{
    Layout = "~/Views/Shared/_DetailLayout.cshtml";
    ViewBag.Title = "Consultancy - Product detail";
}
@section DetailAreaNavigation
{
    <nav class="area">
        <ul>
            <li class="current"><a href="javascript:void(0);">@Model.Project.Name</a></li>
        </ul>
    </nav>
}
@section DetailActionNavigation
{
    <nav class="action">
        <ul>
            <li>@Html.ActionLink("Detail", "Edit", "ProjectConsultancy", new RouteValueDictionary(new { area = "Project", id = Model.Project.Id }), null)
            </li>
            <li>@Html.ActionLink("Project plan", "EditProjectPlan", "ProjectConsultancy", new RouteValueDictionary(new { area = "Project", id = Model.Project.Id }), null)
            </li>
            <li>@Html.ActionLink("Activity details", "ActivityDetail", "ProjectConsultancy", new RouteValueDictionary(new { area = "Project", id = Model.Project.Id }), null)
            </li>
            <li class="current">Product details</li>

            @if (Model.Project.Status != ProjectStatusCodeViewType.Draft && Model.Project.PricingModelType == PricingModelType.TimeAndMaterial)
            {
                <li>@Html.ActionLink("Time sheets", "Timesheet", "ProjectConsultancy", new RouteValueDictionary(new { area = "Project", id = Model.Project.Id }), null)
                </li>
                @*if (Model.IsCurrentUserProjectManager || Model.IsCurrentUserCustomerAssistant)
                {
                <li>@Html.ActionLink("Project time sheets", "ProjectTimesheet", "ProjectConsultancy", new RouteValueDictionary(new { area = "Project", id = Model.Project.Id }), null)
                </li>
                }*@
            }
        </ul>
    </nav>
}
@section LeftNavigation
{
    @if (Model.Products.Count > 0)
    {
        <ul id="Tabs">
            @foreach (var productType in Model.Products.GroupBy(p => p.ProductTypeName))
            {
                @productType.Key

                foreach (var product in productType)
                {
                    <li><a href="#@product.Id" data-controlid="ProductDetailLink"></a></li>
                }
            }
        </ul>   
    }
}
@section AdditionalScripts
{
    <script src="@Url.Content("~/Scripts/jquery.treeTable.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/jquery.cookie.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/persist.js")" type="text/javascript"></script>
    <script>
        $(function() {
            $('fieldset[data-controlid=ProductDetailFieldset]').each(function() {
                RefreshProduct($(this).attr('data-productid'));
            });

            InitializeFormButtons();
        });

        function RefreshProduct(id) {
            $('div[data-productid=' + id + ']').loading('Retrieving product');
            $.ajax({
                url: '@Url.Action("EditProduct")/' + id,
                success: function(html) {
                    $('div[data-productid=' + id + ']').html(html);
                },
                error: function(err) {
                    $('div[data-productid=' + id + ']').showErrorMessage(err.statusText);
                }
            });
        }

        function InitializeFormButtons() {
            $(this).on('click', 'a[data-function=EditProductSubmitButton]', null, function () {
                ShowDetailSaveDialog();
                var productId = $(this).attr('data-productid');
                var form = $('form[data-form=EditProductForm][data-productid=' + productId + ']');

                $.ajax({
                    url: '@Url.Action("EditProduct")',
                    type: 'POST',
                    data: form.serialize(),
                    success: function() {
                        RefreshProduct(productId);
                        HideDetailSaveDialog();
                    },
                    error: function(err) {
                        HideDetailSaveDialog();
                        alert(err.statusText);
                    }
                });
            });
        }
    </script>
}

@if (Model.Products.Count > 0)
{
    foreach (var product in Model.Products)
    {
    <fieldset id="@product.Id" data-controlid="ProductDetailFieldset" data-productid="@product.Id">
        <legend>@product.Name</legend>
        <div data-productid="@product.Id"></div>
    </fieldset>
    }
}