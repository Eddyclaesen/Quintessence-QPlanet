@model Quintessence.QPlanet.ViewModel.Dim.EditDictionaryCompetenceModel
@{
    Layout = "~/Views/Shared/_DetailLayout.cshtml";
    ViewBag.Title = "Admin - Edit dictionary competence";
}
@section DetailAreaNavigation
{
    <nav class="area">
        <ul>
            <li class="current"><a href="javascript:void(0);">@Model.Name</a></li>
        </ul>
    </nav>
}
@section DetailActionNavigation
{
    <nav class="action">
        <ul>
            <li class="current">Competence Detail</li>
        </ul>
    </nav>
}
@section AdditionalScripts
{
    <script src="@Url.Content("~/Scripts/jquery.dataTables.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/jquery.treeTable.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/jquery.cookie.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/persist.js")" type="text/javascript"></script>

    <script>
        $(function () {
            $('#DictionaryTable').treeTable({ persist: true });

            InitializeButtons();
            InitializeAddLevelDialog();

            if (0 != parseInt($('#DictionaryNumberOfUsages').attr('data-value'))) {
                AddNotification('DICUSAGES', 'There are @(Model.DictionaryNumberOfUsages) project(s) using this dictionary. Editing this competence may render those project corrupt!');
            }

            if ('true' == $('#DictionaryIsLive').attr('data-value')) {
                AddNotification('DICISLIVE', 'The dictionary to which this competence belongs marked as Live and is being used in production. Editing this competence may render those project corrupt!');
            }
        });

        function InitializeAddLevelDialog() {
            $('#AddDictionaryLevelDialog').dialog(
                {
                    autoOpen: false,
                    modal: true,
                    resizable: false,
                    width: 650,
                    height: 500,
                    title: 'Add new level'
                });
        }

        function InitializeButtons() {
            $('a[data-function=SaveDictionaryCompetence]').click(function (event) {
                ShowDetailSaveDialog();

                event.preventDefault();

                var form = $('form');

                $.ajax({
                    url: form.attr('action'),
                    type: 'POST',
                    data: form.serialize(),
                    dataType: 'JSON',
                    success: function () {
                        window.location.reload();
                    },
                    error: function (err) {
                        HideDetailSaveDialog();
                        ShowDetailErrorDialog('Save dictionary competence', err);
                    }
                });
            });

            $(this).on('click', 'a[data-function=DeleteDictionaryLevelButton]', null, function (event) {
                event.preventDefault();

                if (!confirm('Are you sure you want to delete this level?'))
                    return;

                ShowDetailSaveDialog();

                $.ajax({
                    url: '@Url.Action("DeleteDictionaryLevel")/' + $(this).attr('data-id'),
                    success: function () {
                        window.location.reload();
                    },
                    error: function (err) {
                        HideDetailSaveDialog();
                        ShowDetailErrorDialog('Delete dictionary level', err);
                    }
                });
            });

            $(this).on('click', 'a[data-function=AddDictionaryLevelButton]', null, function (event) {
                event.preventDefault();

                $('#AddDictionaryLevelDialog').loading('Prepare new level.');
                $('#AddDictionaryLevelDialog').dialog('open');

                $.ajax({
                    url: '@Url.Action("AddDictionaryLevel", new{id = Model.Id})',
                    success: function (html) {
                        $('#AddDictionaryLevelDialog').html(html);
                    },
                    error: function (err) {
                        ShowDetailErrorDialog('Prepare new level', err);
                    }
                });
            });

            $(this).on('click', 'a[data-function=SaveDictionaryLevel]', null, function (event) {
                ShowDetailSaveDialog();

                event.preventDefault();

                var form = $('#AddDictionaryLevelForm');

                $.ajax({
                    url: form.attr('action'),
                    type: 'POST',
                    data: form.serialize(),
                    dataType: 'JSON',
                    success: function () {
                        window.location.reload();
                    },
                    error: function (err) {
                        HideDetailSaveDialog();
                        ShowDetailErrorDialog('Create dictionary level', err);
                    }
                });
            });
        }
    </script>
}

<div class="grid_8">
    <fieldset>
        <legend>@Model.Name</legend>

        <div id="DictionaryNumberOfUsages" data-value="@(Model.DictionaryNumberOfUsages)">
        </div>
        <div id="DictionaryIsLive" data-value="@(Model.DictionaryIsLive.ToString().ToLowerInvariant())">
        </div>

        <div class="row">
            <div>Dictionary</div>
            <div>@Html.ActionLink(Model.DictionaryName, "EditDictionary", new { id = Model.DictionaryId }, new { target = Model.DictionaryId, title = "Click to edit" })
            </div>
        </div>

        <div class="row">
            <div>Cluster</div>
            <div>@Html.ActionLink(Model.DictionaryClusterName, "EditDictionaryCluster", new { id = Model.DictionaryClusterId }, new { target = Model.DictionaryId, title = "Click to edit" })
            </div>
        </div>

        @using (Html.BeginForm())
        {
            @Html.EditorFor(m => m, "BaseEntityViewTemplate")
            <div class="row">
                <div>@Html.DisplayNameFor(m => m.Name)</div>
                <div>@Html.EditorFor(m => m.Name)</div>
            </div>
            <div class="row">
                <div>@Html.DisplayNameFor(m => m.Order)</div>
                <div>@Html.EditorFor(m => m.Order)</div>
            </div>
            <div class="row">
                <div>@Html.DisplayNameFor(m => m.Description)</div>
                <div>@Html.TextAreaFor(m => m.Description, 4, 40, null)</div>
            </div>
            <div class="row"></div>
    
            <div class="right-text">
                <a href="javascript:void();" data-function="SaveDictionaryCompetence" class="button">Save</a>
            </div>

            if (Model.DictionaryCompetenceTranslations != null)
            {
                for (int i = 0; i < Model.DictionaryCompetenceTranslations.Count; i++)
                {
                    @Html.EditorFor(m => m.DictionaryCompetenceTranslations[i], "BaseEntityViewTemplate")
                    <b>@Model.DictionaryCompetenceTranslations[i].LanguageName</b>
                    <div class="row">
                        <div>@Html.DisplayNameFor(m => m.DictionaryCompetenceTranslations[i].Text)</div>
                        <div>@Html.EditorFor(m => m.DictionaryCompetenceTranslations[i].Text)</div>
                    </div>
                    <div class="row">
                        <div>@Html.DisplayNameFor(m => m.DictionaryCompetenceTranslations[i].Description)</div>
                        <div>@Html.TextAreaFor(m => m.DictionaryCompetenceTranslations[i].Description, 4, 40, null)
                        </div>
                    </div>
                    <div class="row"></div>
                }
            }

            <div class="right-text">
                <a href="javascript:void();" data-function="SaveDictionaryCompetence" class="button">Save</a>
            </div>
        }
    </fieldset>
</div>
<div class="grid_8">
    <fieldset>
        <legend>Levels</legend>
        <table id="DictionaryLevelTable" class="dataTable">
            <thead>
                <tr>
                    <th style="width: 100%;">Level</th>
                    <th style="width: 72px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var level in Model.DictionaryLevels.OrderBy(l => l.Level))
                {
                    <tr id="node-@level.Id">
                        <td>
                            @level.Level - @(level.Name.Length > 50 ? level.Name.Substring(0, 50) + "..." : level.Name)
                        </td>
                        <td>
                            @Html.ActionLink("Edit", "EditDictionaryLevel", new { id = level.Id }, new { @class = "edit-link", target = level.DictionaryId })
                            @if (Model.DictionaryNumberOfUsages == 0 && !Model.DictionaryIsLive)
                            {
                                <a href="javascript:void(0);" data-function="DeleteDictionaryLevelButton" data-id="@level.Id" class="delete-link">
                                    Delete</a>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <br />
        <br />

        <div class="right-text">
            <a href="javascript:void();" data-function="AddDictionaryLevelButton" class="button">Add</a>
        </div>
    </fieldset>
</div>

<div id="AddDictionaryLevelDialog"></div>