@model Quintessence.QPlanet.Webshell.Areas.Candidate.Models.ProgramHomeUser.IndexActionModel
@{
    Layout = "~/Views/Shared/_FullDetailLayout.cshtml";
}
@section DetailAreaNavigation
{
    <nav class="area">
        <ul>
            <li class="current"><a href="javascript:void(0);">@Model.User.FullName</a></li>
        </ul>
    </nav>
}
@section DetailActionNavigation
{
    <nav class="action">
        <ul>
            <li class="current">Dayprogram</li>
        </ul>
    </nav>
}
@section AdditionalScripts
{
    <script src="@Url.Content("~/Scripts/fullcalendar.js")" type="text/javascript"></script>

    <script>
        $(function () {
            RefreshDayProgram();
        });

        function RefreshDayProgram() {
            $('#DayProgramPlaceholder').loading('Retrieve day program...');

            $.ajax({
                url: '@Url.Action("UserDayProgram", new { userId = Model.User.Id, year = Model.Date.Year, month = Model.Date.Month, day = Model.Date.Day })',
                success: function (html) {
                    $('#DayProgramPlaceholder').html(html);
                    InitializeUserCalendar();
                    InitializeCandidateCalendars();
                },
                eror: function (err) {
                    alert(err.statusText);
                    $('#DayProgramPlaceholder').html('Unable to retrieve the day program.<br />If this problem keeps recurring, please contact your system administrator');
                }
            });
        }

        function InitializeUserCalendar() {
            var calendar = $('div[data-function=Calendar][data-calendar-type=UserCalendar]');

            var url = '@Url.Action("UserEvents")';
            var firstHour = '@(Model.Date.Date == DateTime.Now.Date ? DateTime.Now.Hour - 1 : 8)';

            calendar.fullCalendar({
                header: false,
                weekends: false,
                editable: false,
                defaultView: 'agendaDay',
                firstHour: parseInt(firstHour),
                minTime: 0,
                maxTime: 24,
                allDaySlot: false,
                height: 750,
                slotMinutes: 5,
                eventSources: [{ url: url }],
                agenda: 'h:mm{ - h:mm}',
                axisFormat: 'HH:mm',
                timeFormat: {
                    agenda: 'HH:mm{ - HH:mm}'
                },
                columnFormat: 'd/MM',
                eventRender: function (event, element) {
                    element.find('div.fc-event-title').html(element.find('div.fc-event-title').text());
                },
                eventAfterRender: function (event, element, view) {
                    $('div[data-function=AssessorBackground][data-processed=false]').each(function () {
                        var backgroundColor = $('div[data-function=AssessorColor][data-assessor-id=' + $(this).attr('data-assessor-id') + ']').attr('data-color');
                        $(this).attr('style', 'background-color: ' + backgroundColor);
                        $(this).attr('data-processed', 'true');
                    });
                }
            });
            calendar.fullCalendar('gotoDate', '@Model.Date.Year', '@(Model.Date.Month - 1)', '@Model.Date.Day');

            $('div[data-function=Calendar] > div > div > div > div').scroll(function () {
                $('div[data-function=Calendar] > div > div > div > div').scrollTop($(this).scrollTop());
            });
        }

        function InitializeCandidateCalendars() {
            $('div[data-function=Calendar][data-calendar-type=CandidateCalendar]').each(function () {
                var calendar = $(this);

                var url = '@Url.Action("CandidateEvents")/' + $(this).attr('data-candidate-id');

                calendar.fullCalendar({
                    header: false,
                    weekends: false,
                    editable: false,
                    defaultView: 'agendaDay',
                    firstHour: 8,
                    minTime: 0,
                    maxTime: 24,
                    allDaySlot: false,
                    height: 750,
                    slotMinutes: 5,
                    eventSources: [{ url: url }],
                    agenda: 'h:mm{ - h:mm}',
                    axisFormat: 'HH:mm',
                    timeFormat: {
                        agenda: 'HH:mm{ - HH:mm}'
                    },
                    columnFormat: 'd/MM',
                    eventRender: function (event, element) {
                        element.find('div.fc-event-title').html(element.find('div.fc-event-title').text());
                    },
                    eventAfterRender: function (event, element, view) {
                        $('div[data-function=AssessorBackground][data-processed=false]').each(function () {
                            var backgroundColor = $('div[data-function=AssessorColor][data-assessor-id=' + $(this).attr('data-assessor-id') + ']').attr('data-color');
                            $(this).attr('style', 'background-color: ' + backgroundColor);
                            $(this).attr('data-processed', 'true');
                        });
                    }
                });
                calendar.fullCalendar('gotoDate', '@Model.Date.Year', '@(Model.Date.Month - 1)', '@Model.Date.Day');

                $('div[data-function=Calendar] > div > div > div > div').scroll(function () {
                    $('div[data-function=Calendar] > div > div > div > div').scrollTop($(this).scrollTop());
                });
            });
        }
    </script>
}

<fieldset>
    <legend>@Model.Date.ToShortDateString()</legend>

    @Html.ActionLink("Print", "GenerateDayProgramReport", new { userId = Model.User.Id, year = Model.Date.Year, month = Model.Date.Month, day = Model.Date.Day }, new { @class = "button" })

    <div id="DayProgramPlaceholder"></div>
</fieldset>
